<!doctype html>
<html>
<head>
	<title>JS ReacTable</title>

	<style type="text/css">
		* {
			border-box: padding-box;
		}

		main {
			width: 200px;
		}

		p {
			background: #eef;
		}

		label {
			display: block;
		}

		input {
			width: 100%;
			margin: 0;
		}
	</style>

	<script>
		if(typeof(webkitAudioContext)!=="undefined") {
			if(typeof(webkitAudioContext.prototype.createGain)==="undefined") {
				webkitAudioContext.prototype.createScriptProcessor=webkitAudioContext.prototype.createJavaScriptNode;
				webkitAudioContext.prototype.createGain=(function() {
					var o=webkitAudioContext.prototype.createGainNode.call(this);
					o._gain=o.gain; o.gain=o._gain;
					o.gain.setTargetAtTime=o._gain.setTargetValueAtTime;
					return o;
				});
				webkitAudioContext.prototype.createDelay=(function(){
					var o=webkitAudioContext.prototype.createDelayNode.call(this);
					o._delayTime=o.delayTime; o.delayTime=o._delayTime;
					o.delayTime.setTargetAtTime=o._delayTime.setTargetValueAtTime;
					return o;
				});
				webkitAudioContext.prototype._createOscillator=webkitAudioContext.prototype.createOscillator;
				webkitAudioContext.prototype.createOscillator=(function() {
					var o=webkitAudioContext.prototype._createOscillator.call(this);
					o._frequency=o.frequency; o.frequency=o._frequency;
					o.frequency.setTargetAtTime=o._frequency.setTargetValueAtTime;
					o._detune=o.detune; o.detune=o._detune;
					o.detune.setTargetAtTime=o._detune.setTargetValueAtTime;
					o.start=o.noteOn;
					o.stop=o.noteOff;
					return o;
				});
				webkitAudioContext.prototype._createBufferSource=webkitAudioContext.prototype.createBufferSource;
				webkitAudioContext.prototype.createBufferSource=(function() {
					var o=webkitAudioContext.prototype._createBufferSource.call(this);
					o._playbackRate=o.playbackRate; o.playbackRate=o._playbackRate;
					o.playbackRate.setTargetAtTime=o._playbackRate.setTargetValueAtTime;
					o.start=function(w,off,dur) {
						if(off===undefined)
							o.noteOn(w);
						else
							o.noteGrainOn(w,off,dur);
					};
					o.stop=o.noteOff;
					return o;
				});
				webkitAudioContext.prototype._createBiquadFilter=webkitAudioContext.prototype.createBiquadFilter;
				webkitAudioContext.prototype.createBiquadFilter=(function() {
					var o=webkitAudioContext.prototype._createBiquadFilter.call(this);
					o._frequency=o.frequency; o.frequency=o._frequency;
					o.frequency.setTargetAtTime=o._frequency.setTargetValueAtTime;
					o._Q=o.Q; o.Q=o._Q;
					o.Q.setTargetAtTime=o._Q.setTargetValueAtTime;
					o._gain=o.gain; o.gain=o._gain;
					o.gain.setTargetAtTime=o._gain.setTargetValueAtTime;
					return o;
				});
				webkitAudioContext.prototype._createDynamicsCompressor=webkitAudioContext.prototype.createDynamicsCompressor;
				webkitAudioContext.prototype.createDynamicsCompressor=(function() {
					var o=webkitAudioContext.prototype._createDynamicsCompressor.call(this);
					o._threshold=o.threshold; o.threshold=o._threshold;
					o.threshold.setTargetAtTime=o._threshold.setTargetValueAtTime;
					o._knee=o.knee; o.knee=o._knee;
					o.knee.setTargetAtTime=o._knee.setTargetValueAtTime;
					o._ratio=o.ratio; o.ratio=o._ratio;
					o.ratio.setTargetAtTime=o._ratio.setTargetValueAtTime;
					o._attack=o.attack; o.attack=o._attack;
					o.attack.setTargetAtTime=o._attack.setTargetValueAtTime;
					return o;
				});
			}
		}
	</script>

	<script type="text/javascript" src="http://mohayonao.github.io/timbre.js/timbre.dev.js"></script>
	<script type="text/javascript" src="http://mohayonao.github.io/subcollider.js/builds/subcollider.js"></script>
</head>
<body>
	<main>
		<p>
			<button id="playback" data-paused="true">Play</button>    <button id="scale">Random Scale</button>
		</p>

		<p>
			<label for="pitch">Pitch</label>
			<input type="range" id="pitch" name="pitch" min="-24" max="24" step="0.1" value="1" />
		</p>
	</main>

	<script>
		window.togglePlayback = function() {
		  var self = document.querySelector('#playback');
		  if (self.dataset.paused == "true") {
		    self.innerHTML = "Pause";
		    T.play();
		    self.dataset.paused = "false";
		  } else {
		    self.innerHTML = "Play";
		    T.pause();
		    self.dataset.paused = "true";
		  }  
		}

		document.querySelector('#playback').addEventListener('click', togglePlayback);

		function randomScale(count) {
		  if (0) {
		    scale = sc.ScaleInfo.at("majorPentatonic");
		  } else {
		    scale = sc.ScaleInfo.at("minorPentatonic");
		  }
		  
		  scaleOffs = scale.degrees().choose(count % 4);
		}

		var domPitch = document.querySelector('#pitch');
		var midicps = T("midicps");
		var midicps2 = T("midicps");

		var scale = sc.Scale.major();
		var scaleOffs = 0;
		document.querySelector('#scale').addEventListener('click', randomScale);

		/*domPitch.addEventListener('input', function() {
		  var gated = (parseFloat(this.value) + 69).nearestInScale(scale, 12);
		  
		  midicps.midi = gated + scaleOffs;
		  this.value = gated - 69;
		});*/

		T("reverb", {room:0.9, damp:0.2, mix:0.45}, T("delay", {time:T.timevalue("bpm120 L4"), fb:0.6, mix:0.3}, T("chorus", {delay:10, rate:2, depth:10, fb:0.5, mix:0.35}, T("tri", {freq: midicps, mul:0.5})))).play();

		T("chorus", {delay:10, rate:2, depth:10, fb:0.75, mix:0.5}, T("tri", {freq: midicps2, mul:0.8})).play();

		T("interval", {interval:T.timevalue("bpm120 1.0.0")}, function(count) {
		  randomScale(count);
		}).on("ended", function() {
		  this.stop();
		}).start();

		T("interval", {interval:T.timevalue("bpm120 0.0.120")}, function(count) {
		  var gated = ((sc.triWindow((count % 6) / 6) * 18) + 69).nearestInScale(scale, 12);
		  midicps.midi = gated + scaleOffs;
		  if (count % 16 == 0) {
		    midicps2.midi = gated + scaleOffs - 36;
		  }
		  domPitch.value = gated - 69;
		}).on("ended", function() {
		  this.stop();
		}).start();

		T.pause();
	</script>
</body>
</html>